---
title: "Лабораторна робота № 6. Побудова моделей класифікації І. Пакет caret"
author: 'Barbir Vladyslav'
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    df_print: paged
  html_notebook:
    toc: true
    toc_float: true
    number_sections: true
editor_options:
  chunk_output_type: inline
encoding: "UTF-8"
---
**Мета:** *Засвоєння базових принципів, знайомство з інструментами та набуття навичок побудови, eкспорту та імпорту моделей класифікації на рівні технології на основі статистичного підходу та моделей машинного навчання засобами мови програмування R та за допомогою універсального інтерфейсу доступа до функцій машинного навчання пакету `caret`.*

## Хід роботи

### Виконання завдання

#### **Підготовка даних**

Спочатку завантажимо необхідні бібліотеки та дані. Ми будемо використовувати пакет `mlbench` для доступу до датасету `PimaIndiansDiabetes`, `tidyverse` для маніпуляцій з даними та caret для побудови моделі.

```{r}
library(mlbench)
library(tidyverse)
library(caret)
library(DBI)
library(RSQLite)

data(PimaIndiansDiabetes)

diabetes_orig <- as_tibble(PimaIndiansDiabetes)

head(diabetes_orig)
```

#### **Навчання моделі класифікації**

Розділимо дані на навчальну та тестову вибірки у співвідношенні 80/20. Потім налаштуємо параметри для крос-валідації та навчимо модель LDA.

```{r}

set.seed(1234) 
trainIndex <- createDataPartition(diabetes_orig$diabetes, p = .8,
                                  list = FALSE,
                                  times = 1)

trainSet <- diabetes_orig[trainIndex, ]
testSet  <- diabetes_orig[-trainIndex, ]

fitCtrl <- trainControl(method = "repeatedcv",
                        number = 10,
                        repeats = 5)

model <- train(diabetes ~ ., data = trainSet,
               method = 'lda',
               trControl = fitCtrl)

fit <- model$finalModel

```

#### **Експорт навченої моделі до бази даних**

Для збереження моделі в базі даних ми спочатку серіалізуємо її (перетворимо в набір символів), а потім запишемо в таблицю SQLite.

```{r}

fit_char <- rawToChar(serialize(fit, NULL, TRUE))
cat("Кількість символів у серіалізованій моделі:", nchar(fit_char))

db <- dbConnect(RSQLite::SQLite(), dbname = "models.sqlite")

dbExecute(db, "DROP TABLE IF EXISTS models")

dbExecute(db, 'CREATE TABLE IF NOT EXISTS models
           (id INTEGER PRIMARY KEY AUTOINCREMENT,
           model_name TEXT,
           model BLOB)')

df <- data.frame(model_name = "Pima_LDA", mdl = fit_char)

query <- dbSendQuery(db, 'INSERT INTO models (model_name, model) VALUES (:model_name, :mdl)')
dbBind(query, params = df)
dbClearResult(query)

cat("\nМодель успішно збережена в базу даних models.sqlite")

```

#### **Імпорт моделі з бази даних та її використання**

Тепер ми імпортуємо збережену модель з бази даних, відновимо її та використаємо для класифікації на тестовій вибірці, щоб перевірити її ефективність.

```{r}

df2 <- dbGetQuery(db, "SELECT model FROM models WHERE model_name = 'Pima_LDA'")

model2 <- unserialize(charToRaw(df2$model[1]))
cat("Клас відновленого об'єкта:", class(model2), "\n")

prediction <- predict(model2, newdata = testSet[, -9])

confusionMatrix(prediction$class, testSet$diabetes)

dbDisconnect(db)

```
## References
1. James, G., Witten, D., Hastie, T., & Tibshirani, R. (2023). *An Introduction to Statistical Learning: with Applications in R (3rd ed.)*. Springer.  
2. Wickham, H., & Grolemund, G. (2017). *R for Data Science: Import, Tidy, Transform, Visualize, and Model Data*. O’Reilly Media.  
3. Kuhn, M., & Silge, J. (2022). *Tidy Modeling with R*. O’Reilly Media.  
4. Han, J., Pei, J., & Kamber, M. (2022). *Data Mining: Concepts and Techniques (4th ed.)*. Morgan Kaufmann.  

