---
title: "Розділ 6 Модуль 2. Моделювання. Лабораторна робота №4. Побудова регресійних моделей"
author: 'Barbir Vladyslav'
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    df_print: paged
  html_notebook:
    toc: true
    toc_float: true
    number_sections: true
editor_options:
  chunk_output_type: inline
encoding: "UTF-8"
---
**Мета:** *Мета: Засвоєння базових принципів, знайомство з інструментами та набуття навичок побудови моделей регресії на рівні технології на основи статистичного підходу та моделей машинного навчання засобами мови програмування R та колекції пакетів `dplyr`, `ggplot2`.*

## Хід роботи

### Виконання завдання

#### **Розуміння даних**

- **Первинний збір даних**

Для аналізу використовується набір даних `PimaIndiansDiabetes` з пакету `mlbench` у середовищі R. Цей датасет містить інформацію про стан здоров'я та наявність діабету у жінок віком від 21 року, що належать до індіанського племені Піма. Вибірка складається з 768 спостережень.

- **Вивчення і перевірка якості даних**

Первинний аналіз даних показав, що в деяких ключових змінних, таких як `pressure` (артеріальний тиск) та `mass` (індекс маси тіла), присутні нульові значення. З фізіологічної точки зору це неможливо, тому такі значення розглядаються як пропущені або некоректно введені дані.

#### **Підготовка даних**

```{r}
# Завантаження необхідних бібліотек та даних
library(mlbench)
library(tibble)
library(dplyr)
library(ggplot2)

data(PimaIndiansDiabetes)
diabetes_orig <- as_tibble(PimaIndiansDiabetes)

# Виведення перших 6 рядків
head(diabetes_orig)
```

Наявність нульових значень у ключових предикторах (`pressure` та `mass`) може суттєво спотворити результати регресійного аналізу. Тому перед моделюванням необхідно провести очищення даних.

1.  **Заміна нульових значень на `NA`**: Замінимо нулі у стовпцях `pressure` та `mass` на `NA` (Not Available), щоб R коректно розпізнавав їх як пропущені дані.
2.  **Видалення рядків з `NA`**: Для побудови моделі парної регресії нам потрібні повні дані для обох змінних. Найпростіший спосіб — видалити всі рядки, де `pressure` або `mass` є `NA`.

```{r}
# Створюємо копію для очищення
diabetes_clean <- diabetes_orig

# Замінюємо 0 на NA у відповідних стовпцях
diabetes_clean$pressure[diabetes_clean$pressure == 0] <- NA
diabetes_clean$mass[diabetes_clean$mass == 0] <- NA

# Видаляємо рядки з пропущеними значеннями у цих стовпцях
diabetes_clean <- diabetes_clean %>%
  filter(!is.na(pressure) & !is.na(mass))

# Перевірка розміру даних до і після очищення
nrow(diabetes_orig) # 768
nrow(diabetes_clean) # 729
```

Після очищення даних кількість спостережень зменшилася з 768 до 729. Тепер можна переходити до моделювання.

#### **Моделювання**

- **Вибір методу моделювання**

Для оцінки залежності артеріального тиску (`pressure`) від індексу маси тіла (`mass`) будемо використовувати модель парної лінійної регресії. Цей метод дозволяє описати лінійну залежність між двома неперервними змінними за допомогою рівняння прямої:

$$pressure = β₀ + β₁ * mass + ε$$
де `β₀` – вільний член (перетин з віссю `Y`), `β₁` – коефіцієнт регресії, що показує зміну pressure при зміні mass на одну одиницю, а `ε` – похибка моделі. Ми будемо використовувати метод найменших квадратів (МНК) для оцінки коефіцієнтів `β₀` та `β₁`.

- **Побудова та оцінка моделі**

Спочатку проведемо розвідувальний аналіз, щоб візуально оцінити зв'язок між змінними та розрахувати коефіцієнт кореляції.

- **Кореляційний аналіз та візуалізація**
```{r}
# Розрахунок коефіцієнта кореляції Пірсона
cor(diabetes_clean$mass, diabetes_clean$pressure)
```

Коефіцієнт кореляції становить приблизно **0.28**, що вказує на наявність слабкого, але позитивного лінійного зв'язку: з ростом індексу маси тіла спостерігається тенденція до підвищення артеріального тиску.

Побудуємо діаграму розсіювання (scatter plot) для візуальної оцінки залежності.

```{r}
ggplot(diabetes_clean, aes(x = mass, y = pressure)) +
  geom_point(alpha = 0.5) +
  stat_smooth(method = "lm", col = "red") +
  labs(title = "Залежність артеріального тиску від індексу маси тіла",
       subtitle = "Лінійна регресія з 95% довірчим інтервалом",
       x = "Індекс маси тіла (mass)",
       y = "Артеріальний тиск (pressure), мм рт. ст.")
```

Графік підтверджує наявність слабкої позитивної тенденції. Більшість точок згрупована, але є викиди, які можуть впливати на модель.

- Побудова лінійної регресійної моделі

Тепер побудуємо саму модель за допомогою функції `lm()` і проаналізуємо її результати.

```{r}
# Побудова моделі
model <- lm(pressure ~ mass, data = diabetes_clean)

# Виведення результатів моделі
summary(model)
```

- **Інтерпретація результатів**

1.  **Коефіцієнти (Coefficients):**
    *   `Intercept` (β₀) = 57.47: Це теоретичне значення артеріального тиску, коли індекс маси тіла дорівнює нулю. У даному контексті цей показник не має практичного сенсу, але є необхідною частиною рівняння.
    *   `mass` (β₁) = 0.458: Цей коефіцієнт є статистично значущим (`p-value < 2e-16`). Він показує, що **з кожним збільшенням індексу маси тіла на одну одиницю, артеріальний тиск в середньому зростає на 0.458 мм рт. ст.**

2.  **Рівняння моделі:** `Артеріальний тиск = 57.47 + 0.458 * Індекс маси тіла`

3.  **Коефіцієнт детермінації (R-squared):**
    *   `Multiple R-squared` = 0.1102: Це означає, що модель пояснює приблизно **11%** варіабельності артеріального тиску. Це невисокий показник, який говорить про те, що індекс маси тіла є важливим, але не єдиним фактором, що впливає на тиск. Існують інші, більш значущі фактори, які не враховані в цій простій моделі.

4.  **Статистична значущість моделі:**
    *   `F-statistic`: 89.53, `p-value`: < 2.2e-16. Дуже низьке p-значення свідчить про те, що модель в цілому є статистично значущою, і зв'язок між тиском та ІМТ не є випадковим.

**Прогноз на основі моделі**

Ми можемо використовувати побудовану модель для прогнозування. Наприклад, розрахуємо очікуваний артеріальний тиск для пацієнток з ІМТ 25, 30 та 35, а також 95% довірчий інтервал для цих прогнозів.

```{r}
# Створюємо датафрейм з новими даними для прогнозу
new_data <- data.frame(mass = c(25, 30, 35))

# Робимо прогноз
predict(model, newdata = new_data, interval = "confidence")
```

```{r}
# Створюємо датафрейм з новими значеннями ІМТ для прогнозу
new_data <- data.frame(mass = c(25, 30, 35))

# Прогнозування середнього значення та 95% довірчого інтервалу
predictions <- predict(model, newdata = new_data, interval = "confidence")

# Об'єднуємо вхідні дані та прогнози в один датафрейм
results_df <- cbind(new_data, predictions)

# Встановлюємо бібліотеку knitr, якщо її ще немає
# install.packages("knitr")
library(knitr)

# Виводимо результати у вигляді гарної таблиці за допомогою kable()
kable(
  results_df,
  caption = "Таблиця 2. Точковий та інтервальний прогноз артеріального тиску",
  col.names = c("Індекс маси тіла (mass)", "Прогнозований тиск (fit)", "Нижня межа 95% (lwr)", "Верхня межа 95% (upr)"),
  digits = 2 
)
```
Наприклад, для пацієнтки з ІМТ 30 модель прогнозує середній артеріальний тиск 71.08 мм рт. ст. з 95% впевненістю, що справжнє середнє значення знаходиться в межах від 70.17 до 72.00 мм рт. ст.

#### **Висновки**

1.  На основі даних `PimaIndiansDiabetes` було побудовано статистично значущу модель парної лінійної регресії, яка описує залежність артеріального тиску від індексу маси тіла.
2.  Встановлено слабкий, але статистично значущий позитивний зв'язок: зі збільшенням ІМТ на 1 одиницю, діастолічний артеріальний тиск в середньому зростає на **0.458 мм рт. ст.**
3.  Коефіцієнт детермінації (R²) становить **11%**, що свідчить про те, що модель має обмежену прогностичну силу. Індекс маси тіла є лише одним із багатьох факторів, що впливають на артеріальний тиск. Для створення більш точної моделі необхідно враховувати інші змінні (наприклад, вік, генетичну схильність, рівень глюкози).
4.  Проведена підготовка даних, що включала обробку аномальних нульових значень, дозволила побудувати більш коректну модель.
5.  Незважаючи на низький R², отримані результати є корисними для розуміння фундаментального зв'язку між масою тіла та артеріальним тиском в аналізованій популяції.

## References
1. James, G., Witten, D., Hastie, T., & Tibshirani, R. (2023). *An Introduction to Statistical Learning: with Applications in R (3rd ed.)*. Springer.  
2. Wickham, H., & Grolemund, G. (2017). *R for Data Science: Import, Tidy, Transform, Visualize, and Model Data*. O’Reilly Media.  
3. Kuhn, M., & Silge, J. (2022). *Tidy Modeling with R*. O’Reilly Media.  
4. Han, J., Pei, J., & Kamber, M. (2022). *Data Mining: Concepts and Techniques (4th ed.)*. Morgan Kaufmann.  

