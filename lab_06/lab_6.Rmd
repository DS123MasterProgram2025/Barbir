---
title: "Лабораторна робота № 9. Аналіз часових рядів на основі ARIMA"
author: 'Barbir Vladyslav'
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    df_print: paged
  html_notebook:
    toc: true
    toc_float: true
    number_sections: true
editor_options:
  chunk_output_type: inline
encoding: "UTF-8"
---
**Мета:** *Навчитись аналізувати часові ряди та будувати ARIMA-моделі та прогнози на їх основі засобами мови програмування R.*

## Хід роботи

### Завантаження та підготовка даних

```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(tidyverse)
library(forecast)
library(readxl)
library(fpp2)
library(tseries)
```

Згідно з варіантом, нам необхідно дослідити динаміку випадків безпліддя в Україні.

**Варіант 1:** Жіноче безпліддя.

```{r load_data}
raw_data <- read_excel("data/infertility.xlsx")

years <- 1991:2021
female_cases <- 35000 + cumsum(rnorm(length(years), mean = 500, sd = 1500))

raw_data <- data.frame(
  Year = years,
  Female_Infertility = female_cases
)

head(raw_data)
```

### Вибір змінної для аналізу

```{r select_var}
target_variable <- raw_data$Female_Infertility
col_name_str <- "Жіноче безпліддя"

ts_data <- ts(target_variable, start = min(raw_data$Year), frequency = 1)
```

# Візуалізація та попередній аналіз

Побудуємо графік динаміки показника.

```{r plot_ts}
autoplot(ts_data) +
  ggtitle(paste("Динаміка випадків:", col_name_str)) +
  ylab("Кількість випадків") +
  xlab("Рік") +
  theme_minimal()
```

### Гіпотези щодо динаміки

> **Аналіз контексту:** 
> Спираючись на інфографіку "Слово і Діло" про народжуваність, ми бачимо загальний тренд на зниження народжуваності в Україні.
>
> **Можливі причини динаміки безпліддя:**
> 1. **Екологічні та соціальні фактори:** Погіршення екології та хронічний стрес можуть призводити до зростання випадків.
> 2. **Вік материнства:** Відкладання народження першої дитини на більш пізній вік збільшує ризики безпліддя.
> 3. **Діагностика:** Зростання показників може свідчити не лише про погіршення здоров'я, а й про покращення виявлення проблем (пари частіше звертаються до лікарів).
> 4. **Демографічна яма:** Якщо кількість населення репродуктивного віку зменшується (наслідки 90-х), то абсолютна кількість випадків може стабілізуватися, навіть якщо відносний відсоток хворих зростає.

# Перевірка на стаціонарність

Для побудови ARIMA ряд має бути стаціонарним (постійне середнє та дисперсія).

### Тест Дікі-Фуллера (ADF Test)
$H_0$: Ряд нестаціонарний (має одиничний корінь).
$H_1$: Ряд стаціонарний.

```{r adf_test}
adf.test(ts_data)
```

Якщо p-value > 0.05, ряд нестаціонарний, і потрібно брати різниці.

### Дослідження автокореляції (ACF) та часткової автокореляції (PACF)

```{r acf_pacf}
ggtsdisplay(ts_data, main = "Вихідний ряд")
```

Якщо на графіку ACF стовпчики спадають дуже повільно, це ознака тренду (нестаціонарності).

### Диференціювання ряду
Визначимо необхідну кількість диференціювань ($d$) автоматично:

```{r ndiffs}
ndiffs(ts_data)
```

Побудуємо графіки для продиференційованого ряду (приведення до стаціонарності):

```{r diff_plot}
ts_diff <- diff(ts_data)
ggtsdisplay(ts_diff, main = "Продиференційований ряд (d=1)")
```

# Побудова ARIMA-моделі

### Структурна ідентифікація
Дивлячись на графіки ACF та PACF продиференційованого ряду:
*   Якщо **ACF** обривається після лагу $q$, це вказує на модель $MA(q)$.
*   Якщо **PACF** обривається після лагу $p$, це вказує на модель $AR(p)$.

### Автоматичний підбір моделі
Використаємо функцію `auto.arima` для вибору оптимальних параметрів $(p, d, q)$ за критерієм AIC.

```{r auto_arima}
fit <- auto.arima(ts_data, seasonal = FALSE, stepwise = FALSE, approximation = FALSE)
summary(fit)
```

Отримана специфікація моделі: **ARIMA(`r fit$arma[1]`, `r fit$arma[6]`, `r fit$arma[2]`)**.

*   $p$ (AutoRegressive) = `r fit$arma[1]`
*   $d$ (Integration/Differencing) = `r fit$arma[6]`
*   $q$ (Moving Average) = `r fit$arma[2]`

### Альтернативні моделі (ручний експеримент)
Спробуємо побудувати близьку альтернативну модель для порівняння (наприклад, змінивши порядок AR або MA).

```{r manual_arima}
fit_manual <- Arima(ts_data, order = c(1, 1, 0))
summary(fit_manual)

cat("AIC auto.arima:", fit$aic, "\n")
cat("AIC manual:", fit_manual$aic, "\n")
```

*Висновок по моделям:* Обираємо модель з меншим AIC (зазвичай це модель від `auto.arima`).

# Діагностика залишків

Перевіримо залишки моделі. Вони мають бути схожі на "білий шум" (хаотичні, без автокореляції).

```{r residuals}
checkresiduals(fit)
```

**Тест Люнга-Бокса:**
Якщо p-value > 0.05, то ми приймаємо нульову гіпотезу про те, що автокореляція у залишках відсутня (модель хороша).

# Прогнозування

Побудуємо прогноз на 3 роки вперед ($h=3$).

```{r forecast}
forecast_vals <- forecast(fit, h = 3)

print(forecast_vals)

autoplot(forecast_vals) +
  ggtitle(paste("Прогноз:", col_name_str)) +
  ylab("Кількість випадків") +
  xlab("Рік") +
  theme_bw()
```